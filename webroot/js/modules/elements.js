/**
 * @project       tusk
 * @author        carsten.coull@swu.de
 * @build         Fri, Nov 17, 2023 2:55 PM ET
 * @release       a433e330c30db45ed9eaf70ee5d4ebbf88e92350 [main]
 * @copyright     Copyright (c) 2023, SWU Stadtwerke Ulm / Neu-Ulm GmbH
 *
 */
import DragDrop from"./dragdrop.js";import Editor from"./editor.js";export default class LayoutElements{constructor(e){this.main=e,this.main.debug,this.DragDrop=new DragDrop,this.elements=document.querySelectorAll(".layout-element"),this.DragDrop.loadElements(this.elements,this.setPosition)}setModal(e){e.addEventListener("modalOpen",(e=>this.initForm(e))),e.addEventListener("modalClosed",(e=>this.onDispatch(e)))}initForm(e){this.main.debug,this.modal=e.detail,this.modalForm=this.modal.modalMain.querySelector("form");let t=document.getElementById("element-id");this.container=document.getElementById("elements-container"),this.fetchElement(t.value),t.addEventListener("change",(e=>{this.fetchElement(e.target.value)})),this.modalForm.addEventListener("submit",(e=>{e.preventDefault();let t=this.modalForm.querySelector("[name=html]");this.editor&&t?this.editor.save().then((e=>{t.value=JSON.stringify(e),this.editor.destroy(),this.sendFrom(this.modalForm)})):this.sendFrom(this.modalForm)}))}fetchElement(e){let t=this.container.dataset.request+"?";t+=new URLSearchParams({layoutmode:!0,elementId:e}).toString(),fetch(t).then((e=>e.text())).then((e=>{if(this.container.innerHTML=e,document.getElementById("editor")){let e=this.modalForm.querySelector("[name=html]");this.editor=new Editor("editor",e.value)}else this.editor=null})).catch((e=>{}))}sendFrom(e){fetch(e.getAttribute("action"),{method:"POST",body:new FormData(e)}).then((e=>e.json())).then((e=>{if(200!=e.status)throw new Exception("something went wrong");this.modal.closeModal()})).catch((e=>{}))}onDispatch(e){this.main.debug;let t=e.detail;this.element=t.parentNode.parentNode;let n=this.readId(this.element);n||window.location.reload(),fetch("/rhino/contents/element/"+n,{headers:{"X-Requested-With":"XMLHttpRequest"}}).then((e=>e.text())).then((e=>this.updateContent(e))).catch()}updateContent(e){if(!e.length)return void this.element.remove();let t=this.element.querySelector(".element-container");t&&(t.innerHTML=e)}readId(e){return e.id.replace("element-","")}setPosition(e,t){let n=e.id.replace("element-","");t<0&&(t=0),fetch("/rhino/contents/change/"+n+"?"+new URLSearchParams({key:"position",value:t}),{headers:{"X-Requested-With":"XMLHttpRequest"}}).then((e=>e.json())).then((e=>{})).catch()}}