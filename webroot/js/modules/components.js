/**
 * @project       tusk
 * @author        carsten.coull@swu.de
 * @build         Wed, Jan 10, 2024 4:53 PM ET
 * @release       f39df71e611dee1cda1bc6540ca6aa0707b9a278 [page-tree]
 * @copyright     Copyright (c) 2024, SWU Stadtwerke Ulm / Neu-Ulm GmbH
 *
 */
import Editor from"./editor.js";import Modal from"./modal.js";export default class LayoutComponents{constructor(e){this.main=e,this.main.debug,this.Config={newButtonSelector:"button[name=new-component]",layoutContainerSelector:".layout-container, .layout-slot",elementSelector:".layout-element"},this.Actions={new:"/rhino/components/new/",update:"/rhino/components/update/",change:"/rhino/components/change/",delete:"/rhino/components/delete/"},this.containers={},document.querySelector(this.Config.layoutContainerSelector)&&this.setup(document)}setup(e){this.pageId=this.main.getPageId(),this.newButtons=e.querySelectorAll(this.Config.newButtonSelector),this.elements=e.querySelectorAll(this.Config.elementSelector),this.layoutContainers=e.querySelectorAll(this.Config.layoutContainerSelector),this.layoutContainers.forEach((e=>{this.containers[e.getAttribute("name")]=e})),this.newButtons.forEach((e=>{e.addEventListener("click",(()=>{this.newComponent(e.value)}))})),this.elements.forEach((e=>{new Component(this,e)}))}async postFetch(e,t=""){return fetch(e,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-Token":this.main.getToken(),"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin",body:JSON.stringify(t)})}newComponent(e){let t=this.containers[e];this.postFetch(this.Actions.new,{region:e,parentId:t.getAttribute("value")}).then((e=>e.text())).then((e=>{let n=new Component(this,e);t.appendChild(n.element),this.setup(n.element)}))}async updateContent(e,t,n,i={}){"save"==e&&(i=await n.getContent()),this.postFetch(t,i).then((e=>e.text())).then((t=>{if("update"==e){let e=new Element(this,t);n.container.insertBefore(e.nodeElement,n.nodeElement)}"delete"!=e&&"update"!=e||n.destroy()}))}setPosition(e,t){let n="/rhino/contents/update/"+e.id.replace("element-","");t<0&&(t=0),this.updateContent("move",n,e,{position:t})}}class Component{constructor(e,t=null){this.Handler=e,this.fields=["template_id","content"],"object"==typeof t&&t.nodeType?this.element=t:"string"==typeof t&&(this.element=this.createElement(t)),this.content=this.element.querySelector("[name=content]"),this.select=this.element.querySelector("[name=template_id]"),this.id=this.element.dataset.id,this.region=this.element.dataset.region,this.initialize()}initialize(){this.saveButton=this.element.querySelector("[name=save]"),this.deleteButton=this.element.querySelector("[name=delete]"),this.toggleButton=this.element.querySelector("[name=toggle]"),this.moveHandle=this.element.querySelector("[name=move]"),this.saveButton.addEventListener("click",(()=>this.update())),this.deleteButton.addEventListener("click",(()=>this.delete())),this.select.addEventListener("change",(()=>this.change({template_id:this.select.value}))),this.element.addEventListener("keydown",(e=>{if(e.ctrlKey&&83===e.keyCode)return e.preventDefault(),this.update("save"),!1})),this.addEditor(),this.addMedia()}async update(){let e=await this.getContent();e.id=this.id,this.Handler.postFetch(this.Handler.Actions.update,e)}async change(e){e.id=this.id,this.Handler.postFetch(this.Handler.Actions.change,e).then((e=>e.text())).then((e=>{let t=new Component(this.Handler,e);this.element.parentElement.insertBefore(t.element,this.element),this.destroy(),this.Handler.setup(t.element)}))}async delete(){this.Handler.postFetch(this.Handler.Actions.delete,{id:this.id}).then((e=>e.text())).then((e=>{this.destroy()}))}createElement(e){let t=document.createElement("template");return t.innerHTML=e.trim(),t.content.firstChild}addEditor(){let e=this.element.querySelector(".editor");if(!e)return;let t=e.closest(".layout-element");this.element.dataset.id==t.dataset.id&&(this.editor=new Editor(e,this.content.value))}addMedia(){let e=this.element.querySelector("[name=mediaButton]");if(!e)return;this.Modal||(this.Modal=new Modal(this));let t=this.Modal.newModal(e,!1);this.Modal.addQuery(t),e.addEventListener("click",(()=>{fetch(e.value).then((e=>e.text())).then((e=>{this.Modal.addContent(t,e),this.Modal.openModal(t)}))})),t.addEventListener("confirm",(e=>{let n=t.querySelector("input[type=radio]:checked");this.media.value=n.value,this.elementHandler.updateContent("update",this.select.dataset.url,this,{media:this.media.value})})),t.addEventListener("close",(e=>{this.Modal.reset(t)}))}async getContent(){if(this.editor){let e=await this.editor.save();this.content.value=JSON.stringify(e),this.content.innerHTML=this.content.value}let e={};return this.fields.forEach((t=>{let n=this.element.querySelector("[name="+t+"]");n&&(e[t]=n.value)})),e}destroy(){this.editor&&this.editor.destroy(),this.element.remove()}}